name: Deploy Sporttyx Backend

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Позволяет запустить вручную кнопкой в Actions

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Показывает структуру, чтобы мы видели, что скачалось
      - name: Diagnostic List
        run: ls -R

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # Сами находим pom.xml и собираем проект там, где он есть
      - name: Build with Maven
        run: |
          POM_PATH=$(find . -name "pom.xml" -not -path "*/target/*" | head -n 1)
          if [ -z "$POM_PATH" ]; then echo "Error: pom.xml not found"; exit 1; fi
          DIR_PATH=$(dirname "$POM_PATH")
          echo "Found pom.xml in: $DIR_PATH"
          cd "$DIR_PATH"
          mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Сами находим dockerfile и собираем образ
      - name: Build Docker image
        run: |
          DOCKER_FILE=$(find . -name "dockerfile" -o -name "Dockerfile" | head -n 1)
          if [ -z "$DOCKER_FILE" ]; then echo "Error: dockerfile not found"; exit 1; fi
          CONTEXT_DIR=$(dirname "$DOCKER_FILE")
          echo "Using Dockerfile at: $DOCKER_FILE"
          
          docker build \
            -t sporttyx-backend:latest \
            -f "$DOCKER_FILE" \
            "$CONTEXT_DIR"
          docker save sporttyx-backend:latest > sporttyx-image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: sporttyx-image.tar
          retention-days: 1

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Load Docker image and Run
        run: |
          docker load < sporttyx-image.tar
          
          # Очистка старого контейнера
          docker stop sporttyx-app || true
          docker rm sporttyx-app || true
          
          # Запуск на порту 8080
          docker run -d \
            --name sporttyx-app \
            --restart always \
            -p 8080:8080 \
            sporttyx-backend:latest
          
          docker image prune -f